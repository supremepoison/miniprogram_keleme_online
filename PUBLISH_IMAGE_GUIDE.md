# 发布图片功能使用指南

## 功能概述

用户在小程序中生成图片后，可以点击"发布作品"将图片和提示词保存到云数据库和云存储。

## 实现的功能

### 1. 云函数 - publishImage

**位置**: `cloudfunctions/publishImage`

**功能**:
- 接收前端上传的图片 URL（来自阿里云 OSS）
- 将图片下载并上传到云存储（路径：`/images/{userId}_{timestamp}.jpg`）
- 将图片地址、提示词、用户信息保存到数据库 `images` 集合

**参数**:
- `imageUrl`: 生成的图片 URL（来自阿里云）
- `prompt`: 提示词
- `userId`: 用户 ID

**返回**:
```javascript
{
  code: 0,
  message: '发布成功',
  data: {
    imageId: 'xxx',
    imageUrl: 'cloud://xxx',
    prompt: 'xxx',
    createTime: 'xxx'
  }
}
```

### 2. 前端实现

#### 创建页面 (`pages/create/create.js`)
- 修改 `onPublish()` 方法
- 检查用户是否登录
- 调用 `publishImage` 云函数
- 发布成功后跳转到首页

#### 我的页面 (`pages/mine/mine.js`)
- 添加 `loadUserImages()` 方法：从数据库加载用户发布的图片
- 添加 `formatTime()` 方法：格式化时间显示
- 在 `onShow()` 中刷新数据

#### 我的页面 UI (`pages/mine/mine.wxml`)
- 显示真实的图片（而不是占位符）
- 添加空状态提示
- 显示发布时间、提示词等信息

## 需要完成的步骤

### 1. 部署云函数

在微信开发者工具中：
1. 右键点击 `cloudfunctions/publishImage` 文件夹
2. 选择 **"上传并部署：云端安装依赖"**
3. 等待部署完成

### 2. 创建数据库集合

在云开发控制台中：
1. 进入"数据库"标签页
2. 创建 `images` 集合
3. 设置权限：**所有用户可读，仅创建者可写**

**集合字段**:
| 字段名 | 类型 | 说明 |
|--------|------|------|
| `_id` | String | 文档 ID（自动生成） |
| `imageUrl` | String | 云存储文件 ID |
| `prompt` | String | 提示词 |
| `userId` | String | 用户 ID |
| `openId` | String | 微信 OpenID |
| `createTime` | Date | 创建时间 |

### 3. 创建云存储目录

在云开发控制台中：
1. 进入"存储"标签页
2. 创建文件夹 `images`
3. 设置权限：**所有用户可读，仅创建者可写**

## 使用流程

### 用户操作流程

1. **登录**：在"我的"页面登录
2. **创建图片**：在"创建"页面输入提示词，生成图片
3. **发布作品**：
   - 点击"发布作品"按钮
   - 等待发布完成
   - 自动跳转到首页
4. **查看作品**：在"我的"页面查看个人画廊

### 技术流程

```
用户点击发布
    ↓
前端检查登录状态
    ↓
调用 publishImage 云函数
    ↓
云函数下载阿里云 OSS 图片
    ↓
上传到云存储 /images/ 目录
    ↓
保存数据到数据库 images 集合
    ↓
返回成功给前端
    ↓
前端跳转到首页
```

## 注意事项

### 1. 图片有效期

- 阿里云 OSS 的图片 URL 有效期为 **24 小时**
- 发布后图片会立即从 OSS 下载并保存到云存储
- 云存储中的图片永久保存

### 2. 网络请求

- 云函数下载图片需要支持 HTTPS
- 下载超时时间：30 秒
- 如果下载失败会返回错误信息

### 3. 权限设置

- 数据库权限：所有用户可读，仅创建者可写
- 云存储权限：所有用户可读，仅创建者可写
- 这样可以确保用户只能修改自己的数据

## 调试方法

### 查看云函数日志

1. 右键点击 `cloudfunctions/publishImage` 文件夹
2. 选择"云端日志"
3. 可以看到详细的执行日志，包括：
   - 开始下载图片
   - 图片下载完成
   - 开始上传到云存储
   - 云存储上传完成
   - 数据库保存完成

### 查看数据库数据

1. 在云开发控制台进入"数据库"标签页
2. 点击 `images` 集合
3. 可以查看所有发布的图片数据

### 查看云存储文件

1. 在云开发控制台进入"存储"标签页
2. 进入 `images` 文件夹
3. 可以查看所有保存的图片

## 常见问题

### Q: 发布失败怎么办？

A: 请检查：
1. 云函数是否已部署
2. 用户是否已登录
3. 云存储和数据库的权限是否正确
4. 查看云函数日志获取详细错误信息

### Q: 图片没有显示？

A: 请检查：
1. 云存储中是否有该图片
2. 数据库中 imageUrl 字段是否正确
3. 图片 URL 是否有效

### Q: 我的页面数据不更新？

A: 请尝试：
1. 下拉刷新页面
2. 重新进入"我的"页面
3. 检查数据库中是否有数据

## 后续优化建议

1. **添加点赞功能**：在 `images` 集合中添加 `likes` 字段
2. **添加收藏功能**：创建单独的收藏集合
3. **图片缓存**：使用小程序缓存机制提升加载速度
4. **分页加载**：当用户发布很多图片时，实现分页加载
5. **删除功能**：允许用户删除自己发布的图片

---

## 相关链接

- [云开发控制台](https://console.cloud.tencent.com/tcb)
- [云数据库文档](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/database.html)
- [云存储文档](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/storage.html)
